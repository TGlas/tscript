!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)}(function(e){"use strict";function n(e){return e.state.search||(e.state.search=new function(){this.posFrom=this.posTo=this.lastQuery=this.query=null,this.overlay=null})}function o(e){return"string"==typeof e&&e==e.toLowerCase()}function r(e,n,r){return e.getSearchCursor(n,r,{caseFold:o(n),multiline:!0})}function t(e,n,o,r,t){e.openDialog?e.openDialog(n,t,{value:r,selectValueOnOpen:!0}):t(prompt(o,r))}function i(e){return e.replace(/\\(.)/g,function(e,n){return"n"==n?"\n":"r"==n?"\r":n})}function a(e){var n=e.match(/^\/(.*)\/([a-z]*)$/);if(n)try{e=new RegExp(n[1],-1==n[2].indexOf("i")?"":"i")}catch(e){}else e=i(e);return("string"==typeof e?""==e:e.test(""))&&(e=/x^/),e}function s(e,n,r){n.queryText=r,n.query=a(r),e.removeOverlay(n.overlay,o(n.query)),n.overlay=function(e,n){return"string"==typeof e?e=new RegExp(e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),n?"gi":"g"):e.global||(e=new RegExp(e.source,e.ignoreCase?"gi":"g")),{token:function(n){e.lastIndex=n.pos;var o=e.exec(n.string);if(o&&o.index==n.pos)return n.pos+=o[0].length||1,"searching";o?n.pos=o.index:n.skipToEnd()}}}(n.query,o(n.query)),e.addOverlay(n.overlay),e.showMatchesOnScrollbar&&(n.annotate&&(n.annotate.clear(),n.annotate=null),n.annotate=e.showMatchesOnScrollbar(n.query,o(n.query)))}function c(o,r,i,a){var c=n(o);if(c.query)return l(o,r);var p=o.getSelection()||c.lastQuery;if(p instanceof RegExp&&"x^"==p.source&&(p=null),i&&o.openDialog){var d=null,y=function(n,r){e.e_stop(r),n&&(n!=c.queryText&&(s(o,c,n),c.posFrom=c.posTo=o.getCursor()),d&&(d.style.opacity=1),l(o,r.shiftKey,function(e,n){var r;n.line<3&&document.querySelector&&(r=o.display.wrapper.querySelector(".CodeMirror-dialog"))&&r.getBoundingClientRect().bottom-4>o.cursorCoords(n,"window").top&&((d=r).style.opacity=.4)}))};!function(e,n,o,r,t){e.openDialog(n,r,{value:o,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){u(e)},onKeyDown:t})}(o,f(o),p,y,function(r,t){var i=e.keyName(r),a=o.getOption("extraKeys"),c=a&&a[i]||e.keyMap[o.getOption("keyMap")][i];"findNext"==c||"findPrev"==c||"findPersistentNext"==c||"findPersistentPrev"==c?(e.e_stop(r),s(o,n(o),t),o.execCommand(c)):"find"!=c&&"findPersistent"!=c||(e.e_stop(r),y(t,r))}),a&&p&&(s(o,c,p),l(o,r))}else t(o,f(o),"Search for:",p,function(e){e&&!c.query&&o.operation(function(){s(o,c,e),c.posFrom=c.posTo=o.getCursor(),l(o,r)})})}function l(o,t,i){o.operation(function(){var a=n(o),s=r(o,a.query,t?a.posFrom:a.posTo);(s.find(t)||(s=r(o,a.query,t?e.Pos(o.lastLine()):e.Pos(o.firstLine(),0))).find(t))&&(o.setSelection(s.from(),s.to()),o.scrollIntoView({from:s.from(),to:s.to()},20),a.posFrom=s.from(),a.posTo=s.to(),i&&i(s.from(),s.to()))})}function u(e){e.operation(function(){var o=n(e);o.lastQuery=o.query,o.query&&(o.query=o.queryText=null,e.removeOverlay(o.overlay),o.annotate&&(o.annotate.clear(),o.annotate=null))})}function f(e){return'<span class="CodeMirror-search-label">'+e.phrase("Search:")+'</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint"></span>'}function p(e,n,o){e.operation(function(){for(var t=r(e,n);t.findNext();)if("string"!=typeof n){var i=e.getRange(t.from(),t.to()).match(n);t.replace(o.replace(/\$(\d)/g,function(e,n){return i[n]}))}else t.replace(o)})}function d(e,o){if(!e.getOption("readOnly")){var s=e.getSelection()||n(e).lastQuery,c='<span class="CodeMirror-search-label">'+(o?e.phrase("Replace all:"):e.phrase("Replace:"))+"</span>";t(e,c+function(e){return' <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+e.phrase("(Use /re/ syntax for regexp search)")+"</span>"}(e),c,s,function(n){n&&(n=a(n),t(e,function(e){return'<span class="CodeMirror-search-label">'+e.phrase("With:")+'</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/>'}(e),e.phrase("Replace with:"),"",function(t){if(t=i(t),o)p(e,n,t);else{u(e);var a=r(e,n,e.getCursor("from")),s=function(){var o,i=a.from();!(o=a.findNext())&&(a=r(e,n),!(o=a.findNext())||i&&a.from().line==i.line&&a.from().ch==i.ch)||(e.setSelection(a.from(),a.to()),e.scrollIntoView({from:a.from(),to:a.to()}),function(e,n,o,r){e.openConfirm?e.openConfirm(n,r):confirm(o)&&r[0]()}(e,function(e){return'<span class="CodeMirror-search-label">'+e.phrase("Replace?")+"</span> <button>"+e.phrase("Yes")+"</button> <button>"+e.phrase("No")+"</button> <button>"+e.phrase("All")+"</button> <button>"+e.phrase("Stop")+"</button> "}(e),e.phrase("Replace?"),[function(){c(o)},s,function(){p(e,n,t)}]))},c=function(e){a.replace("string"==typeof n?t:t.replace(/\$(\d)/g,function(n,o){return e[o]})),s()};s()}}))})}}e.commands.find=function(e){u(e),c(e)},e.commands.findPersistent=function(e){u(e),c(e,!1,!0)},e.commands.findPersistentNext=function(e){c(e,!1,!0,!0)},e.commands.findPersistentPrev=function(e){c(e,!0,!0,!0)},e.commands.findNext=c,e.commands.findPrev=function(e){c(e,!0)},e.commands.clearSearch=u,e.commands.replace=d,e.commands.replaceAll=function(e){d(e,!0)}});
